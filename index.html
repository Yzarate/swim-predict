<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Swim Predict</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="models.js"></script>

  <style>
    :root{
      --bg:#070b14;
      --card:#0b1222;
      --card2:#0e1830;
      --text:#eaf0ff;
      --muted:#b8c3e6;
      --line:rgba(255,255,255,.12);
      --accent:#7aa2ff;
      --good:#41d37e;
      --warn:#ffd166;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #10214a 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{
      max-width: 1100px;
      margin: 28px auto;
      padding: 0 16px 40px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    h1{
      font-size: 28px;
      margin:0;
      letter-spacing:.2px;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      
    }
    .card h2{
      font-size: 16px;
      margin:0 0 10px;
      color:var(--text);
    }
    label{
      display:block;
      font-size: 13px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: #0a1224;
      color: var(--text);
      font-size: 15px;
      box-sizing:border-box;
      margin-bottom: 8px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:0;
      background: linear-gradient(90deg, #3f7cff, #7aa2ff);
      color:#06102a;
      font-weight:700;
      font-size: 15px;
      cursor:pointer;
      margin-top: 10px;
    }
    .row .btn{
     margin-top: 0;
    }

    .btn:active{ transform: translateY(1px); }

    .pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
    }
    .pill.good{ color: var(--good); border-color: rgba(65,211,126,.35); }
    .pill.warn{ color: var(--warn); border-color: rgba(255,209,102,.35); }

    .outputs{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--line);
      display:none;
    }
    .big{
      font-size: 26px;
      font-weight:800;
      margin: 6px 0 0;
      letter-spacing: .2px;
    }
    .small{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
      line-height: 1.6;
    }
    #chart{
     width: 100% !important;
    height: 300px !important;  /* adjust if you want taller/shorter plot */
     display: block;
    }

    .chartWrap{
  padding: 12px 12px 6px;
  background: rgba(255,255,255,.02);
  border:1px solid var(--line);
  border-radius: 16px;
  overflow: hidden;  /* ✅ prevents canvas from overlapping text below */
}
  .chartArea{
    height: 320px;
}

#chart{
  width: 100% !important;
  height: 100% !important;
  display: block;
}
    .chartTitle{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      margin: 2px 4px 6px;
    }
    .chartTitle .left{
      font-weight:700;
      font-size: 14px;
    }
    .chartTitle .right{
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Swim Predict</h1>
        <div class="sub">
          Enter an event, age, and time. You’ll get the current USA Swimming standard (age-group) and a ballpark prediction for next year with a typical range.
        </div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Predict my child’s future time</h2>

        <label for="event">Event</label>
        <select id="event">
  <!-- 50s -->
  <option value="G_50FR_SCY" selected>Girls 50 Free (SCY)</option>
  <option value="G_50BK_SCY">Girls 50 Back (SCY)</option>
  <option value="G_50BR_SCY">Girls 50 Breast (SCY)</option>
  <option value="G_50FL_SCY">Girls 50 Fly (SCY)</option>

  <!-- 100s -->
  <option value="G_100FR_SCY">Girls 100 Free (SCY)</option>
  <option value="G_100BK_SCY">Girls 100 Back (SCY)</option>
  <option value="G_100BR_SCY">Girls 100 Breast (SCY)</option>
  <option value="G_100FL_SCY">Girls 100 Fly (SCY)</option>

  <!-- 200s -->
  <option value="G_200FR_SCY">Girls 200 Free (SCY)</option>
  <option value="G_200IM_SCY">Girls 200 IM (SCY)</option>

  <!-- Distance -->
  <option value="G_500FR_SCY">Girls 500 Free (SCY)</option>
</select>

        <div class="row">
          <div>
            <label for="age">Age (years)</label>
            <input id="age" type="number" step="1" min="6" max="18" value="11" />
          </div>
          <div>
            <label for="sex">Sex</label>
            <select id="sex" disabled>
              <option selected>Female (for now)</option>
            </select>
          </div>
        </div>

        <label for="time">Current time (mm:ss.xx or seconds)</label>
        <input id="time" type="text" value="30.31" placeholder="e.g. 31.45 or 1:06.89" />

        <button class="btn" id="predictBtn">Predict</button>

          <div class="row" style="margin-top:10px;">
        <button class="btn" id="exampleBtn" type="button">Try example</button>
        <button class="btn" id="resetBtn" type="button" style="background: rgba(255,255,255,.10); color: var(--text); border:1px solid var(--line);">Reset</button>
        </div>

        <div class="pills">
          <span class="pill" id="tierPill">Tier: —</span>
          <span class="pill" id="stdPill">Standard: —</span>
        </div>
        
        <div class="outputs" id="outputs">
          <div class="small">Predicted next year (age <span id="ageNext">—</span>)</div>
          <div class="big"><span id="predMedian">—</span></div>
          <div class="small">Typical range (25th–75th): <span id="predRange">—</span></div>
          <div class="small" id="pctUsed"></div>
          <div class="small" id="nPairsNote"></div>

        </div>

        <div class="small" style="margin-top:12px;">
          Tier buckets: Beginner (Unlisted/B), Intermediate (BB/A), Advanced (AA+). Standards are USA Swimming age-group cutoffs.
        </div>
      </div>

      <div class="card">
       <div class="chartWrap">
         <div class="chartTitle">
          <div class="left" id="chartTitle">CDC-like chart (ballpark)</div>
          <div class="right">Typical range (25–75) + median</div>
         </div>

        <div class="chartArea">
          <canvas id="chart"></canvas>
        </div>

        <div class="small" id="coverageNote" style="margin-top:8px;"></div>
      </div>

      <div class="small" style="margin-top:10px; white-space: normal;">
         This is a “ballpark” projection using year-to-year improvement patterns from swimmers with annual best times at consecutive ages.
      </div>
    </div>

    </div>
  </div>

<script>
/* -------------------------
   Helpers: time parsing/formatting
--------------------------*/
function parseSwimTimeToSeconds(str) {
  const s = String(str).trim();
  if (!s) return NaN;

  // mm:ss.xx
  if (s.includes(":")) {
    const parts = s.split(":");
    if (parts.length !== 2) return NaN;

    const minutes = Number(parts[0]);
    const seconds = Number(parts[1]);

    if (!Number.isFinite(minutes) || !Number.isFinite(seconds)) return NaN;
    if (minutes < 0 || seconds < 0 || seconds >= 60) return NaN;

    return minutes * 60 + seconds;
  }

  // plain seconds
  const sec = Number(s);
  return Number.isFinite(sec) ? sec : NaN;
}

function setDefaults(){
  document.getElementById("age").value = "11";
  document.getElementById("time").value = "30.31";
  document.getElementById("event").value = "G_50FR_SCY";

  document.getElementById("tierPill").textContent = "Tier: —";
  document.getElementById("stdPill").textContent = "Standard: —";
  document.getElementById("outputs").style.display = "none";
  document.getElementById("pctUsed").textContent = "";
  document.getElementById("coverageNote").textContent = "";

  // redraw a neutral chart
  drawChart(11, 30.31, "Intermediate", pctImproveGirls50FreeSCY, "Girls 50 Free (SCY)");
}

function setExample(){
  const event = document.getElementById("event").value;

  // Keep age default 11 for examples
  document.getElementById("age").value = "11";

  if (event === "G_50FR_SCY") {
    document.getElementById("time").value = "30.31";
  } else if (event === "G_100FR_SCY") {
    document.getElementById("time").value = "1:10.00";
  } else {
    // coming soon events
    document.getElementById("time").value = "—";
    alert("That event is not wired yet. Choose 50 Free or 100 Free.");
    return;
  }
}

document.getElementById("resetBtn").addEventListener("click", () => {
  setDefaults();
});

document.getElementById("exampleBtn").addEventListener("click", () => {
  setExample();
  document.getElementById("predictBtn").click();
});

function fmtPct(x){
  if (!Number.isFinite(x)) return "—";
  const sign = x > 0 ? "+" : "";
  return `${sign}${x.toFixed(2)}%`;
}

function formatSecondsToSwimTime(seconds) {
  const sec = Number(seconds);
  if (!Number.isFinite(sec)) return "—";
  if (sec < 60) return sec.toFixed(2);
  const minutes = Math.floor(sec / 60);
  const rem = sec - minutes * 60;
  const remStr = rem.toFixed(2).padStart(5, "0");
  return `${minutes}:${remStr}`;
}

function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

/* -------------------------
   USA Swimming Motivational Standards — AGE GROUP (SCY)
   Faster is better: must be <= cutoff to achieve letter.
   Source: USA Swimming Motivational Standards (age-group PDF)
--------------------------*/
function getAgeGroupKey(ageInt){
  if (ageInt <= 10) return "10U";
  if (ageInt <= 12) return "11-12";
  if (ageInt <= 14) return "13-14";
  if (ageInt <= 16) return "15-16";
  return "17-18";
}

// Girls 50 Free SCY (age group)
const standardsGirls50FreeSCY = {
  "10U":   { B:39.79, BB:35.99, A:32.09, AA:30.89, AAA:29.59, AAAA:28.29 },
  "11-12": { B:33.99, BB:31.69, A:29.29, AA:28.09, AAA:26.99, AAAA:25.79 },
  "13-14": { B:32.49, BB:30.19, A:27.89, AA:26.69, AAA:25.59, AAAA:24.39 },
  "15-16": { B:31.79, BB:29.49, A:27.29, AA:26.09, AAA:24.99, AAAA:23.89 },
  "17-18": { B:31.39, BB:29.09, A:26.89, AA:25.79, AAA:24.69, AAAA:23.49 }
};

// Girls 100 Free SCY (age group)
const standardsGirls100FreeSCY = {
  "10U":   { B:90.79, BB:81.09, A:71.49, AA:68.29, AAA:64.99, AAAA:61.79 },
  "11-12": { B:74.69, BB:69.39, A:63.99, AA:61.39, AAA:58.69, AAAA:55.99 },
  "13-14": { B:70.99, BB:65.89, A:60.89, AA:58.29, AAA:55.79, AAAA:53.29 },
  "15-16": { B:68.79, BB:63.79, A:58.89, AA:56.49, AAA:53.99, AAAA:51.59 },
  "17-18": { B:68.09, BB:63.19, A:58.39, AA:55.89, AAA:53.49, AAAA:51.09 }
};

// Girls 50 Breast SCY (age group)
const standardsGirls50BreastSCY = {
  "10U":   { B:54.59, BB:48.69, A:42.79, AA:40.89, AAA:38.89, AAAA:36.89 },
  "11-12": { B:43.99, BB:40.89, A:37.69, AA:36.19, AAA:34.59, AAAA:32.99 },
  "13-14": { B:42.09, BB:39.09, A:36.09, AA:34.59, AAA:33.09, AAAA:31.59 },
  "15-16": { B:41.09, BB:38.19, A:35.19, AA:33.79, AAA:32.29, AAAA:30.79 },
  "17-18": { B:40.39, BB:37.49, A:34.59, AA:33.19, AAA:31.69, AAAA:30.29 }
};

// Girls 50 Back SCY (age group)
const standardsGirls50BackSCY = {
  "10U":   { B:48.59, BB:43.29, A:37.99, AA:36.19, AAA:34.39, AAAA:32.59 },
  "11-12": { B:38.79, BB:35.99, A:33.19, AA:31.79, AAA:30.49, AAAA:29.09 },
  "13-14": { B:36.19, BB:33.69, A:31.09, AA:29.79, AAA:28.49, AAAA:27.19 },
  "15-16": { B:35.29, BB:32.69, A:30.19, AA:28.99, AAA:27.69, AAAA:26.49 },
  "17-18": { B:34.59, BB:32.19, A:29.69, AA:28.39, AAA:27.19, AAAA:25.99 }
};

// Girls 100 Back SCY (age group)
const standardsGirls100BackSCY = {
  "10U":   { B:105.79, BB:93.99, A:82.29, AA:78.39, AAA:74.49, AAAA:70.59 },
  "11-12": { B:86.59, BB:79.79, A:72.99, AA:69.59, AAA:66.19, AAAA:62.69 },
  "13-14": { B:76.89, BB:71.39, A:65.89, AA:63.19, AAA:60.49, AAAA:57.69 },
  "15-16": { B:74.69, BB:69.39, A:64.09, AA:61.39, AAA:58.69, AAAA:56.09 },
  "17-18": { B:73.39, BB:68.09, A:62.89, AA:60.29, AAA:57.69, AAAA:54.99 }
};

// Girls 100 Breast SCY (age group)
const standardsGirls100BreastSCY = {
  "10U":   { B:120.29, BB:106.89, A:93.59, AA:89.09, AAA:84.69, AAAA:80.19 },
  "11-12": { B:96.49,  BB:89.29,  A:82.19, AA:78.59, AAA:75.09, AAAA:71.49 },
  "13-14": { B:88.69,  BB:82.29,  A:75.99, AA:72.89, AAA:69.69, AAAA:66.49 },
  "15-16": { B:85.89,  BB:79.79,  A:73.69, AA:70.59, AAA:67.49, AAAA:64.49 },
  "17-18": { B:84.79,  BB:78.79,  A:72.69, AA:69.69, AAA:66.69, AAAA:63.59 }
};

function getStandardLetter(ageInt, timeSec, standardsByGroup){
  const group = getAgeGroupKey(ageInt);
  const s = standardsByGroup[group];
  if(!s) return {letter:"N/A", tier:"Beginner", group};

  let letter = "Unlisted";
  if(timeSec <= s.AAAA) letter = "AAAA";
  else if(timeSec <= s.AAA) letter = "AAA";
  else if(timeSec <= s.AA) letter = "AA";
  else if(timeSec <= s.A) letter = "A";
  else if(timeSec <= s.BB) letter = "BB";
  else if(timeSec <= s.B) letter = "B";

  const tier =
    (letter === "AAAA" || letter === "AAA" || letter === "AA") ? "Advanced" :
    (letter === "A" || letter === "BB") ? "Intermediate" :
    "Beginner";

  return {letter, tier, group};
}

/* -------------------------
   Improvement tables
   % improvement for age_from -> age_from+1
   (Use your existing 50 Free table here if you already had it.
    I’m providing a reasonable placeholder structure PLUS the full 100 Free table you computed.)
--------------------------*/
let IMPROVEMENT_MODELS = null; // loaded from improvement_models.json

// IMPORTANT:
// If you already have a real 50 Free improvement object from your prior work,
// replace the placeholder below with your real one.
// The key name MUST be: pctImproveGirls50FreeSCY

function getPctImprove(ageFrom, tier, improveTable){
  const MIN_TIER_N = 20;
  const MIN_OVERALL_N = 15;

  const tierTable = improveTable?.[tier];
  const overallTable = improveTable?.["Overall"];

  const tierRow = tierTable?.[ageFrom] || null;
  const overallRow = overallTable?.[ageFrom] || null;

  // If tier row exists and has enough n (or no n provided), use it
  if (tierRow) {
    if (!Number.isFinite(tierRow.n) || tierRow.n >= MIN_TIER_N) return tierRow;
  }

  // Otherwise fall back to overall if available and sufficient
  if (overallRow) {
    if (!Number.isFinite(overallRow.n) || overallRow.n >= MIN_OVERALL_N) return overallRow;
  }

  // Nothing reliable
  return null;
}
function applyPct(timeSec, pct){
  // pct is % improvement; positive means faster -> lower time
  return timeSec * (1 - (pct/100));
}
    
/* -------------------------
   Chart
--------------------------*/
let chart = null;

function getEventLabel(event){
  if (event === "G_50FR_SCY") return "Girls 50 Free (SCY)";
  if (event === "G_50BR_SCY") return "Girls 50 Breast (SCY)";
  if (event === "G_100FR_SCY") return "Girls 100 Free (SCY)";
  return "Event";
}

function drawChart(ageNow, timeNow, tier, improveTable, eventLabel){
  const startAge = clamp(Math.floor(ageNow), 6, 18);
  const ages = [];
  const med = [];
  const low = [];
  const high = [];

  let tMed = timeNow;
  let tLow = timeNow;
  let tHigh = timeNow;

for (let a = startAge; a <= 18; a++) {

  // First point = current age/time
  if (a === startAge) {
    ages.push(a);
    med.push(tMed);
    low.push(tLow);
    high.push(tHigh);
    continue;
  }

const lastAgePlotted = ages[ages.length - 1];
document.getElementById("coverageNote").textContent =
  `Projection ends at age ${lastAgePlotted} because year-to-year data is sparse beyond that age for this tier/event.`;

  // Need the improvement for (a-1) -> a
  const pctRow =
    getPctImprove(a - 1, tier, improveTable) ||
    getPctImprove(a - 1, "Overall", improveTable);

  // If we don't have year-to-year data, STOP the chart here
  if (!pctRow) break;

  // Step forward one year
  tMed = applyPct(tMed, pctRow.p50);
  tLow = applyPct(tLow, pctRow.p75);
  tHigh = applyPct(tHigh, pctRow.p25);

  const bandMin = Math.min(tLow, tHigh);
  const bandMax = Math.max(tLow, tHigh);

  // Now add the age + values
  ages.push(a);
  med.push(tMed);
  low.push(bandMin);
  high.push(bandMax);
}

  // Chart title
  document.getElementById("chartTitle").textContent = `${eventLabel} • ballpark trajectory`;

  const ctx = document.getElementById("chart").getContext("2d");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: ages.map(String),
      datasets: [
        // Invisible helper (low edge)
        {
          label: "low-edge-helper",
          data: low,
          borderWidth: 0,
          pointRadius: 0,
          fill: false
        },
        // Shaded band
        {
          label: "Typical range (25th–75th)",
          data: high,
          borderWidth: 0,
          pointRadius: 0,
          fill: { target: 0 }
        },
        // Median
        {
          label: "Median prediction",
          data: med,
          borderWidth: 3,
          pointRadius: 2,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: "#eaf0ff",
            filter: (item, data) => data.datasets[item.datasetIndex].label !== "low-edge-helper"
          }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.y;
              if (v == null) return "";
              return `${ctx.dataset.label}: ${formatSecondsToSwimTime(v)}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: "#b8c3e6" },
          grid: { color: "rgba(255,255,255,.06)" },
          title: { display: true, text: "Age", color: "#b8c3e6" }
        },
        y: {
          ticks: {
            color: "#b8c3e6",
            callback: (v) => formatSecondsToSwimTime(v)
          },
          grid: { color: "rgba(255,255,255,.06)" },
          title: { display: true, text: "Time", color: "#b8c3e6" }
        }
      }
    }
  });
}

const EVENT_TO_MODEL_KEY = {
  "G_50FR_SCY": "G_SCY_50FR",
  "G_100FR_SCY": "G_SCY_100FR"
};

// Converts dropdown codes like "G_50BK_SCY" -> models.js key "G_SCY_50BK"
function defaultModelKeyForEvent(eventCode){
  const m = /^G_(\d+)([A-Z]{2})_SCY$/.exec(eventCode);
  if (!m) return null;
  const dist = m[1];     // e.g., "50"
  const stroke = m[2];   // e.g., "BK", "FR", "BR", "FL", "IM"
  return `G_SCY_${dist}${stroke}`;
}

function getModelForEvent(eventCode){
  const all = window.SWIM_MODELS;
  if (!all) return null;

  const key =
    EVENT_TO_MODEL_KEY[eventCode] ||
    defaultModelKeyForEvent(eventCode) ||
    eventCode;

  return all[key] || null;
}

function predictNextTimeFromModel(timeNow, model) {
  // Model predicts DROP in seconds (positive = faster).
  const dropBase = model.slope * timeNow + model.intercept;

  const drop50 = dropBase + model.residP50;
  const drop25 = dropBase + model.residP25;
  const drop75 = dropBase + model.residP75;

  // Convert "drop" into "next time"
  const next50 = timeNow - drop50;
  const next25 = timeNow - drop25;
  const next75 = timeNow - drop75;

  // Typical range should be ordered low..high in TIME (lower time = faster)
  const lo = Math.min(next25, next75);
  const hi = Math.max(next25, next75);

  // Guardrail: never go below 0.00
  return {
    pred50: Math.max(0, next50),
    lo: Math.max(0, lo),
    hi: Math.max(0, hi),
    drop50, drop25, drop75
  };
}

/* -------------------------
   Predict Button
--------------------------*/
document.getElementById("predictBtn").addEventListener("click", () => {
  const age = parseInt(document.getElementById("age").value, 10);
  const time = parseSwimTimeToSeconds(document.getElementById("time").value);
  const event = document.getElementById("event").value;

  // Optional: show that models.js is loaded (does NOT affect calculations)
  const model = getModelForEvent(event);
  const mappedKey = (typeof EVENT_TO_MODEL_KEY !== "undefined") ? EVENT_TO_MODEL_KEY[event] : "(no mapping)";
  const nKeys = window.SWIM_MODELS ? Object.keys(window.SWIM_MODELS).length : 0;
  
// Overall data coverage note (from models.js if available)
const np = document.getElementById("nPairsNote");
if (np) {
  if (model && Number.isFinite(model.nPairs)) {
    np.textContent = `Data coverage (overall): n=${model.nPairs} consecutive-age pairs`;
  } else {
    np.textContent = "";
  }
}
  if (!Number.isFinite(age) || !Number.isFinite(time)) {
    alert("Please enter a valid age and time (seconds or mm:ss.xx).");
    return;
  }

  const ageInt = clamp(Math.floor(age), 6, 18);

  const standards =
  (event === "G_50FR_SCY") ? standardsGirls50FreeSCY :
  (event === "G_50BR_SCY") ? standardsGirls50BreastSCY :
  (event === "G_100FR_SCY") ? standardsGirls100FreeSCY :
  null;

const improveTable = IMPROVEMENT_MODELS ? IMPROVEMENT_MODELS[event] : null;

  const eventLabel = getEventLabel(event);

  // If not wired yet
  if (!standards || !improveTable) {
    document.getElementById("outputs").style.display = "block";
    document.getElementById("tierPill").textContent = "Tier: Coming soon";
    document.getElementById("tierPill").className = "pill warn";
    document.getElementById("stdPill").textContent = "This event is not wired yet";
    document.getElementById("stdPill").className = "pill warn";
    document.getElementById("ageNext").textContent = Math.floor(age) + 1;
    document.getElementById("predMedian").textContent = "—";
    document.getElementById("predRange").textContent = "—";
    document.getElementById("pctUsed").textContent = "";
    document.getElementById("coverageNote").textContent = "";
    drawChart(age, time, "Beginner", pctImproveGirls100FreeSCY, eventLabel); // placeholder chart
    return;
  }

  const std = getStandardLetter(ageInt, time, standards);

  // Pill styling
  document.getElementById("tierPill").textContent = `Tier: ${std.tier}`;
  document.getElementById("tierPill").className =
    "pill " + (std.tier === "Advanced" ? "good" : (std.tier === "Intermediate" ? "warn" : ""));
  document.getElementById("stdPill").textContent = `Standard: ${std.letter} (${std.group})`;
  document.getElementById("stdPill").className = "pill";

  // Use % improvement tables (original working approach)
  const pct = getPctImprove(ageInt, std.tier, improveTable);
  if (!pct) {
    alert("Not enough data at this age to predict yet.");
    return;
  }

  const nTxt = Number.isFinite(pct.n) ? ` • nPairs=${pct.n}` : "";
document.getElementById("pctUsed").textContent =
  `Model used (${std.tier}, age ${ageInt}→${ageInt+1}): median ${fmtPct(pct.p50)} (typical ${fmtPct(pct.p25)} to ${fmtPct(pct.p75)})${nTxt}`;

  const nextAge = Math.floor(age) + 1;
  const pred50 = applyPct(time, pct.p50);
  const pred25 = applyPct(time, pct.p25);
  const pred75 = applyPct(time, pct.p75);

  document.getElementById("outputs").style.display = "block";
  document.getElementById("ageNext").textContent = nextAge;
  document.getElementById("predMedian").textContent = formatSecondsToSwimTime(pred50);
  document.getElementById("predRange").textContent =
    `${formatSecondsToSwimTime(Math.min(pred25, pred75))} – ${formatSecondsToSwimTime(Math.max(pred25, pred75))}`;

  drawChart(age, time, std.tier, improveTable, eventLabel);
});
function updateEventDropdownLabels(){
  const sel = document.getElementById("event");
  if (!sel) return;

  for (const opt of sel.options) {
    const eventCode = opt.value;
    const m = getModelForEvent(eventCode);

    // If there is a model for this event, remove "— coming soon"
    if (m) {
      opt.textContent = opt.textContent.replace(" — coming soon", "");
    }
  }
}

function updateEventDropdownStatus(){
  const sel = document.getElementById("event");
  if (!sel) return;

  for (const opt of sel.options) {
    const code = opt.value;

    // Remove any previous tag
    let label = opt.textContent
      .replace(" ✅ ready", "")
      .replace(" ⚠ coverage only", "")
      .replace(" — coming soon", "");

    const hasModel = !!getModelForEvent(code);

    const hasStandards =
  (code === "G_50FR_SCY") || (code === "G_50BR_SCY") || (code === "G_100FR_SCY");

    const hasImprove = !!(IMPROVEMENT_MODELS && IMPROVEMENT_MODELS[code]);

    if (hasStandards && hasImprove) {
      opt.textContent = label + " ✅ ready";
    } else if (hasModel) {
      opt.textContent = label + " ⚠ coverage only";
    } else {
      opt.textContent = label + " — coming soon";
    }
  }
}

async function loadImprovementModels(){
  const res = await fetch("improvement_models.json", { cache: "no-store" });
  if (!res.ok) throw new Error(`Failed to load improvement_models.json (${res.status})`);
  return await res.json();
}

async function initApp(){
  try {
    IMPROVEMENT_MODELS = await loadImprovementModels();

    // Update dropdown tags now that we know which events have data
    updateEventDropdownStatus();

    // Draw a default chart using the default selected event + default inputs
    const event = document.getElementById("event").value;
    const age = parseInt(document.getElementById("age").value, 10);
    const time = parseSwimTimeToSeconds(document.getElementById("time").value);
    const eventLabel = getEventLabel(event);

    const improveTable = IMPROVEMENT_MODELS[event];
    if (improveTable && Number.isFinite(age) && Number.isFinite(time)) {
      // Use "Intermediate" just for the initial view; user will click Predict for tier-based chart
      drawChart(age, time, "Intermediate", improveTable, eventLabel);
    }
  } catch (err) {
    console.error(err);
    // Optional: show a friendly message
    const cn = document.getElementById("coverageNote");
    if (cn) cn.textContent = "Could not load improvement models. Please refresh.";
  }
}

initApp();

</script>

</body>
</html>


